<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenerife Beach Rank</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
        :root {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-light: #666;
            --green: #2ecc71;
            --yellow: #f1c40f;
            --red: #e74c3c;
            --footer-bg: #000000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            padding-bottom: 120px;
        }

        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 2rem; color: #2c3e50; }
        
        .lang-switcher { margin: 15px 0; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .lang-btn {
            background: white; border: 1px solid #ddd; padding: 0; border-radius: 50%;
            cursor: pointer; font-size: 1.8rem; transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); width: 48px; height: 48px;
            display: flex; align-items: center; justify-content: center; line-height: 1;
        }
        .lang-btn:hover { transform: scale(1.15); border-color: #3498db; }
        .lang-btn.active { border-color: #3498db; background: #ebf5ff; transform: scale(1.1); box-shadow: 0 0 8px rgba(52, 152, 219, 0.4); }

        .nav-btn {
            background-color: #3498db; color: white; border: none; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: background 0.2s; font-size: 1rem;
        }
        .nav-btn:hover { background-color: #2980b9; }
        .nav-btn.secondary { background-color: #7f8c8d; }

        #list-view, #map-view { display: none; }
        .active-view { display: block !important; }

        #map-container {
            height: 75vh; width: 100%; border-radius: 12px; border: 2px solid #ddd;
            margin-top: 20px;
        }

        .subtitle { color: var(--text-light); font-size: 0.9rem; margin-top: 5px; }
        .last-updated { font-size: 0.8rem; color: #888; margin-top: 10px; font-weight: bold; }

        .beach-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg); border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s;
            border-top: 6px solid #ccc;
        }
        .card:hover { transform: translateY(-3px); }
        
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        
        .beach-name-link { text-decoration: none; color: inherit; flex-grow: 1; display: block; }
        .beach-name { font-size: 1.1rem; font-weight: 700; margin: 0; color: #2c3e50; transition: color 0.2s; }
        .beach-name:hover { color: #3498db; text-decoration: underline; }
        
        .town-name { font-size: 0.85rem; color: #7f8c8d; margin-top: 2px; font-weight: 500; }
        .click-hint { font-size: 0.7rem; color: #3498db; margin-top: 2px; display: block; font-weight: normal; }
        .score-badge { background: #333; color: white; padding: 5px 12px; border-radius: 20px; font-weight: bold; margin-left: 10px; white-space: nowrap; }

        .metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 15px; }
        .metric-item {
            background: #f8f9fa; padding: 8px 2px; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            min-height: 80px; justify-content: center;
        }
        .metric-emoji { font-size: 1.2rem; margin-bottom: 4px; }
        .metric-label { font-size: 0.55rem; color: #777; text-transform: uppercase; font-weight: bold; letter-spacing: 0.3px; }
        .metric-value { font-weight: 600; font-size: 0.85rem; color: #444; }

        .status-green { border-color: var(--green); }
        .status-green .score-badge { background-color: var(--green); }
        .status-yellow { border-color: var(--yellow); }
        .status-yellow .score-badge { background-color: var(--yellow); color: #333; }
        .status-red { border-color: var(--red); }
        .status-red .score-badge { background-color: var(--red); }

        .loading { text-align: center; grid-column: 1 / -1; padding: 100px; color: #666; font-style: italic; }

        .main-footer {
            background-color: var(--footer-bg); color: #ffffff; text-align: center;
            padding: 25px 10px; position: fixed; bottom: 0; left: 0; width: 100%;
            font-size: 13px; z-index: 1000;
        }
    </style>
</head>
<body>

<header>
    <h1 id="title-text">Tenerife Beach Rank</h1>
    <div class="lang-switcher">
        <button class="lang-btn active" id="btn-en" onclick="setLanguage('en')">üá¨üáß</button>
        <button class="lang-btn" id="btn-es" onclick="setLanguage('es')">üá™üá∏</button>
        <button class="lang-btn" id="btn-de" onclick="setLanguage('de')">üá©üá™</button>
        <button class="lang-btn" id="btn-fr" onclick="setLanguage('fr')">üá´üá∑</button>
        <button class="lang-btn" id="btn-ru" onclick="setLanguage('ru')">üá∑üá∫</button>
        <button class="lang-btn" id="btn-nl" onclick="setLanguage('nl')">üá≥üá±</button>
        <button class="lang-btn" id="btn-pt" onclick="setLanguage('pt')">üáµüáπ</button>
    </div>
    <div id="subtitle-text" class="subtitle">Live ranking: Weather, Wind & Wave Safety</div>
    <div id="last-update" class="last-updated">...</div>
</header>

<div id="list-view" class="active-view">
    <div style="text-align: center; margin-bottom: 20px;">
        <button class="nav-btn" onclick="showMap()">üó∫Ô∏è Open Map View</button>
    </div>
    <div id="app" class="beach-grid">
        <div class="loading">Loading live data from Tenerife...</div>
    </div>
</div>

<div id="map-view">
    <div style="text-align: center;">
        <button class="nav-btn secondary" onclick="showList()">‚¨ÖÔ∏è Back to List</button>
    </div>
    <div id="map-container"></div>
</div>

<footer class="main-footer">
    ¬© 2026 Tenerife Beach Rank. <a href="https://dataraul.github.io/ranking-tenerife-beaches/" style="color: #3498db; text-decoration: none;">Live Site</a>
</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    const i18n = {
        en: { title: "Tenerife Beach Rank", sub: "Live ranking based on Weather, Wind & Waves", temp: "Temp", wind: "Wind", clouds: "Clouds", waves: "Waves", update: "Last Update", mapHint: "Click name for Google Maps", btnMap: "üó∫Ô∏è Open Map View", btnBack: "‚¨ÖÔ∏è Back to List" },
        es: { title: "Ranking Playas Tenerife", sub: "Clasificaci√≥n en vivo por clima, viento y olas", temp: "Temp", wind: "Viento", clouds: "Nubes", waves: "Olas", update: "√öltima act.", mapHint: "Clic nombre para Google Maps", btnMap: "üó∫Ô∏è Ver Mapa", btnBack: "‚¨ÖÔ∏è Volver a Lista" },
        de: { title: "Teneriffa Strand-Ranking", sub: "Live-Ranking nach Wetter, Wind & Wellen", temp: "Temp", wind: "Wind", clouds: "Wolken", waves: "Wellen", update: "Letztes Update", mapHint: "Klicken f√ºr Google Maps", btnMap: "üó∫Ô∏è Karte √∂ffnen", btnBack: "‚¨ÖÔ∏è Zur√ºck zur Liste" },
        fr: { title: "Classement Plages T√©n√©rife", sub: "Classement en direct (M√©t√©o, Vent, Vagues)", temp: "Temp", wind: "Vent", clouds: "Nuages", waves: "Vagues", update: "Mis √† jour", mapHint: "Cliquez pour Google Maps", btnMap: "üó∫Ô∏è Voir la Carte", btnBack: "‚¨ÖÔ∏è Retour √† la liste" },
        ru: { title: "–†–µ–π—Ç–∏–Ω–≥ –ø–ª—è–∂–µ–π –¢–µ–Ω–µ—Ä–∏—Ñ–µ", sub: "–ñ–∏–≤–æ–π —Ä–µ–π—Ç–∏–Ω–≥: –ø–æ–≥–æ–¥–∞, –≤–µ—Ç–µ—Ä –∏ –≤–æ–ª–Ω—ã", temp: "–¢–µ–º–ø.", wind: "–í–µ—Ç–µ—Ä", clouds: "–û–±–ª–∞–∫–∞", waves: "–í–æ–ª–Ω—ã", update: "–û–±–Ω–æ–≤–ª–µ–Ω–æ", mapHint: "–ö–ª–∏–∫ –¥–ª—è Google Maps", btnMap: "üó∫Ô∏è –û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ä—Ç—É", btnBack: "‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É" },
        nl: { title: "Tenerife Strand Ranglijst", sub: "Live ranglijst op basis van weer en golven", temp: "Temp", wind: "Wind", clouds: "Wolken", waves: "Golven", update: "Laatste update", mapHint: "Klik voor Google Maps", btnMap: "üó∫Ô∏è Kaart openen", btnBack: "‚¨ÖÔ∏è Terug naar lijst" },
        pt: { title: "Ranking Praias Tenerife", sub: "Ranking ao vivo baseado no clima e ondas", temp: "Temp", wind: "Vento", clouds: "Nuvens", waves: "Ondas", update: "√öltima atualiz.", mapHint: "Clique para Google Maps", btnMap: "üó∫Ô∏è Abrir Mapa", btnBack: "‚¨ÖÔ∏è Voltar √† Lista" }
    };

    const beaches = [
        { name:"Playa de Las Vistas", town:"Los Cristianos", coast:"south", lat:28.0518, lon:-16.7265 },
        { name:"Playa de Los Cristianos", town:"Los Cristianos", coast:"south", lat:28.0504, lon:-16.7226 },
        { name:"Playa del Camis√≥n", town:"Playa de las Am√©ricas", coast:"south", lat:28.0531, lon:-16.7314 },
        { name:"Playa de las Am√©ricas", town:"Playa de las Am√©ricas", coast:"south", lat:28.0583, lon:-16.7358 },
        { name:"Playa de Troya", town:"Costa Adeje", coast:"south", lat:28.0673, lon:-16.7363 },
        { name:"Playa de Fa√±ab√©", town:"Costa Adeje", coast:"south", lat:28.0877, lon:-16.7408 },
        { name:"Playa del Duque", town:"Costa Adeje", coast:"south", lat:28.0908, lon:-16.7431 },
        { name:"Playa de La Pinta", town:"Costa Adeje", coast:"south", lat:28.0776, lon:-16.7380 },
        { name:"Playa del Bobo", town:"Costa Adeje", coast:"south", lat:28.0734, lon:-16.7388 },
        { name:"Playa de Torviscas", town:"Costa Adeje", coast:"south", lat:28.0827, lon:-16.7394 },
        { name:"Playa de La Enramada", town:"Costa Adeje", coast:"south", lat:28.0991, lon:-16.7512 },
        { name:"Playa Diego Hern√°ndez", town:"La Caleta", coast:"south", lat:28.1068, lon:-16.7565 },
        { name:"Playa de Abama", town:"Gu√≠a de Isora", coast:"south", lat:28.1697, lon:-16.7932 },
        { name:"Playa San Juan", town:"Playa San Juan", coast:"southwest", lat:28.1789, lon:-16.8122 },
        { name:"Playa de Alcal√°", town:"Alcal√°", coast:"southwest", lat:28.1994, lon:-16.8286 },
        { name:"Playa de la Arena", town:"Puerto Santiago", coast:"west", lat:28.2285, lon:-16.8407 },
        { name:"Playa de los Gu√≠os", town:"Puerto Santiago", coast:"west", lat:28.2464, lon:-16.8431 },
        { name:"Playa de El M√©dano", town:"El M√©dano", coast:"east", lat:28.0435, lon:-16.5385 },
        { name:"Playa de la Tejita", town:"El M√©dano", coast:"east", lat:28.0333, lon:-16.5593 },
        { name:"Playa de la Pelada", town:"El M√©dano", coast:"east", lat:28.0573, lon:-16.5204 },
        { name:"Playa del Cabezo", town:"El M√©dano", coast:"east", lat:28.0478, lon:-16.5302 },
        { name:"Playa de La Mareta", town:"El M√©dano", coast:"east", lat:28.0298, lon:-16.5721 },
        { name:"Playa de Monta√±a Roja", town:"El M√©dano", coast:"east", lat:28.0333, lon:-16.5492 },
        { name:"Playa de las Galletas", town:"Las Galletas", coast:"south", lat:28.0076, lon:-16.6575 },
        { name:"Playa de la Ballena", town:"Las Galletas", coast:"south", lat:28.0063, lon:-16.6663 },
        { name:"Playa Amarilla", town:"Las Galletas", coast:"south", lat:28.0084, lon:-16.6479 },
        { name:"Playa de Los Abrigos", town:"Los Abrigos", coast:"south", lat:28.0264, lon:-16.5916 },
        { name:"Playa Grande (Por√≠s)", town:"El Por√≠s", coast:"east", lat:28.1601, lon:-16.4262 },
        { name:"Playa de Las Teresitas", town:"San Andr√©s", coast:"north", lat:28.5096, lon:-16.1837 },
        { name:"Playa de Las Gaviotas", town:"San Andr√©s", coast:"north", lat:28.5147, lon:-16.1687 },
        { name:"Playa de Antequera", town:"Anaga", coast:"north", lat:28.5447, lon:-16.1264 },
        { name:"Playa de Benijo", town:"Taganana", coast:"north", lat:28.5724, lon:-16.1867 },
        { name:"Playa de Alm√°ciga", town:"Taganana", coast:"north", lat:28.5702, lon:-16.2005 },
        { name:"Playa del Roque de las Bodegas", town:"Taganana", coast:"north", lat:28.5673, lon:-16.2114 },
        { name:"Playa de Valleseco", town:"San Andr√©s", coast:"north", lat:28.4831, lon:-16.2238 },
        { name:"Playa Jard√≠n", town:"Puerto de la Cruz", coast:"north", lat:28.4168, lon:-16.5574 },
        { name:"Playa de Marti√°nez", town:"Puerto de la Cruz", coast:"north", lat:28.4189, lon:-16.5383 },
        { name:"Playa del Castillo", town:"Puerto de la Cruz", coast:"north", lat:28.4183, lon:-16.5539 },
        { name:"Playa del Muelle", town:"Puerto de la Cruz", coast:"north", lat:28.4186, lon:-16.5501 },
        { name:"Playa del Bollullo", town:"La Orotava", coast:"north", lat:28.4217, lon:-16.5165 },
        { name:"Playa de los Patos", town:"La Orotava", coast:"north", lat:28.4239, lon:-16.5076 },
        { name:"Playa del Anc√≥n", town:"La Guancha", coast:"north", lat:28.4258, lon:-16.4983 },
        { name:"Playa del Socorro", town:"Los Realejos", coast:"north", lat:28.3941, lon:-16.6041 },
        { name:"Playa de San Marcos", town:"Icod de los Vinos", coast:"north", lat:28.3753, lon:-16.7138 },
        { name:"Playa de Agua Dulce", town:"Icod de los Vinos", coast:"north", lat:28.3789, lon:-16.7725 },
        { name:"Playa de Garachico", town:"Garachico", coast:"north", lat:28.3736, lon:-16.7644 },
        { name:"Playa de la Caleta", town:"Garachico", coast:"northwest", lat:28.3768, lon:-16.7877 },
        { name:"Playa del Puertito", town:"Garachico", coast:"northwest", lat:28.3721, lon:-16.8164 },
        { name:"Playa de la Nea", town:"Radazul", coast:"east", lat:28.4068, lon:-16.3214 },
        { name:"Playa de Radazul", town:"Radazul", coast:"east", lat:28.4021, lon:-16.3268 },
        { name:"Playa de Tabaiba", town:"Tabaiba", coast:"east", lat:28.3975, lon:-16.3353 },
        { name:"Playa de Lima", town:"Boca Cangrejo", coast:"east", lat:28.3123, lon:-16.3689 },
        { name:"Playa Adeje", town:"Adeje", coast:"south", lat:28.1152, lon:-16.7656 },
        { name:"Playa Callao Salvaje", town:"Callao Salvaje", coast:"south", lat:28.1221, lon:-16.7765 },
        { name:"Playa Para√≠so", town:"Playa Para√≠so", coast:"south", lat:28.1256, lon:-16.7712 },
        { name:"Playa del Duque Norte", town:"Costa Adeje", coast:"south", lat:28.0934, lon:-16.7456 },
        { name:"Charco del Viento", town:"La Guancha", coast:"north", lat:28.3724, lon:-16.7022 },
        { name:"Bajamar Pools", town:"Bajamar", coast:"north", lat:28.5562, lon:-16.3475 },
        { name:"Punta del Hidalgo", town:"Punta del Hidalgo", coast:"north", lat:28.5694, lon:-16.3276 },
        { name:"Playa Chimisay", town:"G√º√≠mar", coast:"east", lat:28.3465, lon:-16.4352 },
        { name:"Playa El Socorro", town:"El Socorro", coast:"north", lat:28.3588, lon:-16.5841 },
        { name:"Playa La Arena", town:"Tacoronte", coast:"north", lat:28.5003, lon:-16.4245 },
        { name:"Playa Blanca", town:"Costa Adeje", coast:"south", lat:28.1050, lon:-16.7765 },
        { name:"Playa El Bollullo Natural", town:"La Orotava", coast:"north", lat:28.4200, lon:-16.5180 },
        { name:"Playa El Por√≠s", town:"El Por√≠s", coast:"east", lat:28.1601, lon:-16.4262 },
        { name:"Playa de Los Patos Oeste", town:"La Orotava", coast:"north", lat:28.4245, lon:-16.5090},
        { name:"Playa de El Puertito", town:"Garachico", coast:"northwest", lat:28.3715, lon:-16.8180},
        { name:"Playa de El Socorro Sur", town:"Los Realejos", coast:"north", lat:28.3950, lon:-16.6020},
        { name:"Playa de San Juan Norte", town:"Playa San Juan", coast:"southwest", lat:28.1795, lon:-16.8130},
        { name:"Playa de la Jaquita", town:"Bajamar", coast:"north", lat:28.5568, lon:-16.3445},
        { name:"Playa del Anc√≥n Sur", town:"La Guancha", coast:"north", lat:28.4250, lon:-16.5000},
        { name:"Playa Chimisay Sur", town:"G√º√≠mar", coast:"east", lat:28.3450, lon:-16.4370},
        { name:"Playa El Camis√≥n Norte", town:"Playa de las Am√©ricas", coast:"south", lat:28.0550, lon:-16.7320},
        { name:"Playa La Pinta Norte", town:"Costa Adeje", coast:"south", lat:28.0785, lon:-16.7385},
        { name:"Playa del Bobo Sur", town:"Costa Adeje", coast:"south", lat:28.0740, lon:-16.7392},
        { name:"Playa Torviscas Norte", town:"Costa Adeje", coast:"south", lat:28.0835, lon:-16.7397},
        { name:"Playa de Diego Hern√°ndez Norte", town:"La Caleta", coast:"south", lat:28.1075, lon:-16.7568},
        { name:"Playa de Abama Norte", town:"Gu√≠a de Isora", coast:"south", lat:28.1705, lon:-16.7935},
        { name:"Playa de Alcal√° Sur", town:"Alcal√°", coast:"southwest", lat:28.2005, lon:-16.8289},
        { name:"Playa del Cabezo Norte", town:"El M√©dano", coast:"east", lat:28.0485, lon:-16.5305},
        { name:"Playa de Monta√±a Roja Sur", town:"El M√©dano", coast:"east", lat:28.0345, lon:-16.5495},
        { name:"Playa de La Mareta Sur", town:"El M√©dano", coast:"east", lat:28.0305, lon:-16.5725},
        { name:"Playa de Las Galletas Sur", town:"Las Galletas", coast:"south", lat:28.0065, lon:-16.6670},
        { name:"Playa de la Ballena Sur", town:"Las Galletas", coast:"south", lat:28.0068, lon:-16.6665},
        { name:"Playa Amarilla Norte", town:"Las Galletas", coast:"south", lat:28.0087, lon:-16.6485},
        { name:"Playa de Los Abrigos Sur", town:"Los Abrigos", coast:"south", lat:28.0275, lon:-16.5925},
        { name:"Playa Grande Norte", town:"El Por√≠s", coast:"east", lat:28.1610, lon:-16.4250},
        { name:"Playa de Las Teresitas Este", town:"San Andr√©s", coast:"north", lat:28.5105, lon:-16.1845},
        { name:"Playa de Las Gaviotas Norte", town:"San Andr√©s", coast:"north", lat:28.5155, lon:-16.1695},
        { name:"Playa de Antequera Sur", town:"Anaga", coast:"north", lat:28.5455, lon:-16.1275},
        { name:"Playa de Alm√°ciga Norte", town:"Taganana", coast:"north", lat:28.5715, lon:-16.2015},
        { name:"Playa del Roque de las Bodegas Norte", town:"Taganana", coast:"north", lat:28.5685, lon:-16.2125},
        { name:"Playa Valleseco Norte", town:"San Andr√©s", coast:"north", lat:28.4845, lon:-16.2245},
        { name:"Playa Jard√≠n Sur", town:"Puerto de la Cruz", coast:"north", lat:28.4175, lon:-16.5580},
        { name:"Playa Marti√°nez Sur", town:"Puerto de la Cruz", coast:"north", lat:28.4195, lon:-16.5388},
        { name:"Playa del Castillo Sur", town:"Puerto de la Cruz", coast:"north", lat:28.4190, lon:-16.5545},
        { name:"Playa del Muelle Sur", town:"Puerto de la Cruz", coast:"north", lat:28.4191, lon:-16.5505},
        { name:"Playa del Bollullo Oeste", town:"La Orotava", coast:"north", lat:28.4225, lon:-16.5175},
        { name:"Playa de los Patos Este", town:"La Orotava", coast:"north", lat:28.4255, lon:-16.5085},
        { name:"Playa El Anc√≥n Norte", town:"La Guancha", coast:"north", lat:28.4265, lon:-16.4990},
        { name:"Playa El Socorro Norte", town:"Los Realejos", coast:"north", lat:28.3945, lon:-16.6045},
        { name:"Playa de San Marcos Sur", town:"Icod de los Vinos", coast:"north", lat:28.3760, lon:-16.7145},
        { name:"Playa Agua Dulce Sur", town:"Icod de los Vinos", coast:"north", lat:28.3795, lon:-16.7735},
        { name:"Playa Garachico Sur", town:"Garachico", coast:"north", lat:28.3745, lon:-16.7655},
        { name:"Playa Caleta Sur", town:"Garachico", coast:"northwest", lat:28.3778, lon:-16.7885}
    ];

    let currentLang = 'en';
    let globalBeachData = [];
    let map = null;
    let markers = [];

    async function fetchWeatherData() {
        try {
            // OPTIMIZATION: BATCH REQUESTS
            // Instead of 100+ separate calls, we send all coordinates in ONE string.
            const lats = beaches.map(b => b.lat).join(',');
            const lons = beaches.map(b => b.lon).join(',');

            const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=temperature_2m,cloud_cover,wind_speed_10m&wind_speed_unit=kmh`;
            const marineUrl = `https://marine-api.open-meteo.com/v1/marine?latitude=${lats}&longitude=${lons}&current=wave_height`;

            const [wRes, mRes] = await Promise.all([fetch(weatherUrl), fetch(marineUrl)]);
            const wData = await wRes.json();
            const mData = await mRes.json();

            // Open-Meteo returns an array of objects when multiple lats/lons are provided
            globalBeachData = beaches.map((beach, index) => {
                const weather = Array.isArray(wData) ? wData[index] : wData;
                const marine = Array.isArray(mData) ? mData[index] : mData;

                const rawData = {
                    name: beach.name,
                    town: beach.town,
                    coast: beach.coast,
                    lat: beach.lat,
                    lon: beach.lon,
                    temp: weather.current.temperature_2m,
                    wind: weather.current.wind_speed_10m,
                    clouds: weather.current.cloud_cover,
                    wave: marine.current.wave_height || 0
                };
                return calculateScore(rawData);
            });

            renderBeaches();
            if(map) updateMapMarkers();
            updateTimestamp();
        } catch (e) {
            console.error("API Error:", e);
            document.getElementById('app').innerHTML = '<div class="loading">Error loading data. Please refresh later.</div>';
        }
    }

    function calculateScore(beach) {
        let score = 0;
        if (beach.temp >= 22 && beach.temp <= 30) score += 4;
        else if (beach.temp >= 19 && beach.temp < 22) score += 2;
        else score += 1;

        if (beach.wind < 20) score += 3;
        else if (beach.wind < 30) score += 1.5;

        if (beach.clouds < 20) score += 3;
        else if (beach.clouds < 50) score += 1.5;

        score = Math.round(score);
        let status = score >= 8 ? 'green' : (score >= 6 ? 'yellow' : 'red');

        const isNorth = beach.coast === 'north' || beach.coast === 'northwest';
        const redLimit = isNorth ? 2.5 : 2.0;
        const yellowLimit = isNorth ? 1.5 : 1.2;

        if (beach.wave > redLimit) status = 'red';
        else if (beach.wave > yellowLimit && status === 'green') status = 'yellow';

        return { ...beach, score, status, waveLimits: { yellow: yellowLimit, red: redLimit } };
    }

    function getEmojis(beach) {
        let waveEmoji = 'üü¢';
        if (beach.wave > beach.waveLimits.red) waveEmoji = 'üî¥';
        else if (beach.wave > beach.waveLimits.yellow) waveEmoji = 'üü°';
        return {
            temp: beach.temp > 28 ? 'üî•' : (beach.temp > 20 ? '‚òÄÔ∏è' : 'üå•Ô∏è'),
            wind: beach.wind > 22 ? 'üö©' : (beach.wind > 12 ? 'üçÉ' : 'üí®'),
            clouds: beach.clouds > 50 ? '‚òÅÔ∏è' : (beach.clouds > 15 ? '‚õÖ' : '‚òÄÔ∏è'),
            waves: waveEmoji
        };
    }

    function setLanguage(lang) {
        currentLang = lang;
        const data = i18n[lang];
        document.getElementById('title-text').textContent = data.title;
        document.getElementById('subtitle-text').textContent = data.sub;
        document.querySelector('button[onclick="showMap()"]').textContent = data.btnMap;
        document.querySelector('button[onclick="showList()"]').textContent = data.btnBack;
        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${lang}`).classList.add('active');
        renderBeaches();
        updateTimestamp();
    }

    function updateTimestamp() {
        const now = new Date();
        const label = i18n[currentLang].update;
        document.getElementById('last-update').textContent = `${label}: ${now.toLocaleTimeString()}`;
    }

    function renderBeaches() {
        const app = document.getElementById('app');
        const langData = i18n[currentLang];
        app.innerHTML = '';

        globalBeachData.sort((a, b) => b.score - a.score).forEach(beach => {
            const icons = getEmojis(beach);
            const mapsUrl = `https://www.google.com/maps?q=${beach.lat},${beach.lon}`;
            app.innerHTML += `
                <div class="card status-${beach.status}">
                    <div class="card-header">
                        <a href="${mapsUrl}" target="_blank" class="beach-name-link">
                            <h2 class="beach-name">${beach.name}</h2>
                            <div class="town-name">üìç ${beach.town}</div>
                            <span class="click-hint">${langData.mapHint}</span>
                        </a>
                        <div class="score-badge">${beach.score}/10</div>
                    </div>
                    <div class="metrics">
                        <div class="metric-item"><span class="metric-emoji">${icons.temp}</span><span class="metric-label">${langData.temp}</span><span class="metric-value">${beach.temp}¬∞C</span></div>
                        <div class="metric-item"><span class="metric-emoji">${icons.wind}</span><span class="metric-label">${langData.wind}</span><span class="metric-value">${beach.wind} <small>km/h</small></span></div>
                        <div class="metric-item"><span class="metric-emoji">${icons.clouds}</span><span class="metric-label">${langData.clouds}</span><span class="metric-value">${beach.clouds}%</span></div>
                        <div class="metric-item"><span class="metric-emoji">${icons.waves}</span><span class="metric-label">${langData.waves}</span><span class="metric-value">${beach.wave}m</span></div>
                    </div>
                </div>`;
        });
    }

    function showMap() {
        document.getElementById('list-view').classList.remove('active-view');
        document.getElementById('map-view').classList.add('active-view');
        if (!map) initMap();
        else setTimeout(() => { map.invalidateSize(); }, 100); 
    }

    function showList() {
        document.getElementById('map-view').classList.remove('active-view');
        document.getElementById('list-view').classList.add('active-view');
    }

    function initMap() {
        map = L.map('map-container').setView([28.2916, -16.6291], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);
        updateMapMarkers();
    }

    function updateMapMarkers() {
        if (!map || globalBeachData.length === 0) return;
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        globalBeachData.forEach(beach => {
            let color = beach.status === 'green' ? '#2ecc71' : (beach.status === 'yellow' ? '#f1c40f' : '#e74c3c');
            const marker = L.circleMarker([beach.lat, beach.lon], { radius: 8, fillColor: color, color: '#fff', weight: 2, opacity: 1, fillOpacity: 0.8 }).addTo(map);
            marker.bindPopup(`<b>${beach.name}</b><br>Score: ${beach.score}/10<br>Waves: ${beach.wave}m`);
            markers.push(marker);
        });
    }

    fetchWeatherData();
</script>
</body>
</html>
